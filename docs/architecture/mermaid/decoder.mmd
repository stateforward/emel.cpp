stateDiagram-v2
  direction TB
  [*] --> initialized
  initialized --> validating_request : decode [always] / begin_decode_
  validating_request --> errored : [lambda_guards_63_46] / reject_invalid_validate_
  validating_request --> validate_decision : [lambda_guards_26_44] / run_validate_
  validate_decision --> errored : [lambda_guards_103_38] / none
  validate_decision --> sanitizing_batch : [lambda_guards_99_34] / none
  sanitizing_batch --> sanitize_decision : [always] / run_sanitize_batch_
  sanitize_decision --> errored : [lambda_guards_103_38] / none
  sanitize_decision --> initializing_batch : [lambda_guards_99_34] / none
  initializing_batch --> initialize_batch_decision : [always] / run_initialize_batch_
  initialize_batch_decision --> errored : [lambda_guards_103_38] / none
  initialize_batch_decision --> updating_memory_pre : [lambda_guards_99_34] / none
  updating_memory_pre --> update_memory_decision : [always] / run_update_memory_
  update_memory_decision --> errored : [lambda_guards_103_38] / none
  update_memory_decision --> preparing_memory_batch_initial : [lambda_guards_99_34] / none
  preparing_memory_batch_initial --> prepare_memory_batch_initial_decision : [always] / run_prepare_memory_batch_
  prepare_memory_batch_initial_decision --> optimizing_memory : [lambda_guards_115_48] / none
  prepare_memory_batch_initial_decision --> errored : [lambda_guards_119_48] / none
  prepare_memory_batch_initial_decision --> reserving_output : [lambda_guards_99_34] / none
  optimizing_memory --> optimize_memory_decision : [always] / run_optimize_memory_
  optimize_memory_decision --> errored : [lambda_guards_103_38] / none
  optimize_memory_decision --> preparing_memory_batch_retry : [lambda_guards_99_34] / none
  preparing_memory_batch_retry --> prepare_memory_batch_retry_decision : [always] / run_prepare_memory_batch_
  prepare_memory_batch_retry_decision --> errored : [lambda_guards_103_38] / none
  prepare_memory_batch_retry_decision --> reserving_output : [lambda_guards_99_34] / none
  reserving_output --> errored : [lambda_guards_71_47] / reject_invalid_reserve_output_
  reserving_output --> reserve_decision : [lambda_guards_67_45] / run_reserve_output_
  reserve_decision --> errored : [lambda_guards_103_38] / none
  reserve_decision --> processing_ubatch : [lambda_guards_99_34] / none
  processing_ubatch --> finalizing_outputs : [lambda_guards_11_42] / none
  processing_ubatch --> ubatch_decision : [lambda_guards_87_47] / on_invalid_ubatch_size_
  processing_ubatch --> ubatch_decision : [lambda_guards_83_44] / run_process_ubatch_
  ubatch_decision --> handling_ubatch_failure : [lambda_guards_103_38] / none
  ubatch_decision --> processing_ubatch : [lambda_guards_99_34] / none
  handling_ubatch_failure --> rollback_decision : [always] / run_rollback_ubatch_
  rollback_decision --> errored : [lambda_guards_103_38] / capture_rollback_error_
  rollback_decision --> errored : [lambda_guards_99_34] / capture_ubatch_error_
  finalizing_outputs --> finalize_decision : [always] / run_finalize_outputs_
  finalize_decision --> errored : [lambda_guards_103_38] / none
  finalize_decision --> done : [lambda_guards_99_34] / none
  done --> initialized : [always] / mark_done_
  errored --> initialized : [always] / ensure_last_error_
  validating_request --> errored : decode [always] / on_unexpected_
  validate_decision --> errored : decode [always] / on_unexpected_
  sanitizing_batch --> errored : decode [always] / on_unexpected_
  sanitize_decision --> errored : decode [always] / on_unexpected_
  initializing_batch --> errored : decode [always] / on_unexpected_
  initialize_batch_decision --> errored : decode [always] / on_unexpected_
  updating_memory_pre --> errored : decode [always] / on_unexpected_
  update_memory_decision --> errored : decode [always] / on_unexpected_
  preparing_memory_batch_initial --> errored : decode [always] / on_unexpected_
  prepare_memory_batch_initial_decision --> errored : decode [always] / on_unexpected_
  optimizing_memory --> errored : decode [always] / on_unexpected_
  optimize_memory_decision --> errored : decode [always] / on_unexpected_
  preparing_memory_batch_retry --> errored : decode [always] / on_unexpected_
  prepare_memory_batch_retry_decision --> errored : decode [always] / on_unexpected_
  reserving_output --> errored : decode [always] / on_unexpected_
  reserve_decision --> errored : decode [always] / on_unexpected_
  processing_ubatch --> errored : decode [always] / on_unexpected_
  ubatch_decision --> errored : decode [always] / on_unexpected_
  handling_ubatch_failure --> errored : decode [always] / on_unexpected_
  rollback_decision --> errored : decode [always] / on_unexpected_
  finalizing_outputs --> errored : decode [always] / on_unexpected_
  finalize_decision --> errored : decode [always] / on_unexpected_
  done --> errored : decode [always] / on_unexpected_
  errored --> errored : decode [always] / on_unexpected_
